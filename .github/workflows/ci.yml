name: Image Processing CI

on:
  push:
    branches: [main, master]  # branch name lang
  pull_request:
    branches: [main, master]  # Pull request triggers  for main brach lang

jobs:
  test-and-process:
    runs-on: ubuntu-latest  #  i run yung latest ubuntu
    permissions:
      contents: write  # Permission lang para makapag write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}  #  about sa github token lang for repository
        fetch-depth: 0  # Fetch the full history for the repository (kelangan para makita yung mga binago)

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'  # para makita yung python version

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip  # Ensure pip is up to date
        pip install -r requirements.txt  # Install dependencies listed in requirements.txt

    - name: Clean output directory (delete old outputs)
      run: |
        echo "üóëÔ∏è Cleaning output directory..."
        rm -rf output_images/*  # Remove lang yung existing na laman nung output_images
        echo "‚úÖ Old outputs deleted"

    - name: Ensure output directory exists
      run: |
        mkdir -p output_images  # check if meron na output images folder
        echo "Output directory ready"

    - name: Process images with 7 effects
      run: |
        echo "üé® Applying effects: Posterize, Anime, Sepia, Dream, CLAHE, Threshold, Mirror"
        python image_processor.py  # eto yung mag proccess nung mga image gamit yung techniques

    - name: Run tests & display technique summary
      run: |
        echo "=== Running Technique Summary Tests ==="
        python -m pytest -v -s tests/test_image_processing.py  #  run lang yung test script para ma check if tama yung mga techniques

    - name: Display processing results
      run: |
        echo "=== Processed Images ==="
        ls -lh output_images/ || echo "No images processed"  #  naka list yung mga files sa output folder para ma check 
        echo ""
        echo "Total files: $(ls output_images/ | wc -l)"  # bilangin  yung mga na process na images

    - name: Commit and push processed images back to GitHub
      run: |
        git config --global user.name "GitHub Actions Bot"  # Set GitHub Actions Bot as the committer
        git config --global user.email "actions@github.com"  # Set the email for commits
        git add output_images/  # Add processed images to Git staging area
        git diff --staged --quiet || git commit -m "ü§ñ Auto-update: Processed images from workflow"  # Commit changes if there are any new images
        git push origin HEAD:main  # Changed to push to the `main` branch

    - name: Upload processed images
      uses: actions/upload-artifact@v4
      with:
        name: processed-images  # Name for the artifact
        path: output_images/  # Path to the processed images directory
        if-no-files-found: warn  # If no files are found, issue a warning
