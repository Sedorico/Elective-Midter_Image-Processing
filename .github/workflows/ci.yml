name: Image Processing CI

on:
  push:
    branches: [main, master, add-two-effects-jr]  # branch name
  pull_request:
    branches: [main, master]  # Pull request triggers for main or master

jobs:
  test-and-process:
    runs-on: ubuntu-latest  # Specifies the environment to run the job on (Ubuntu)
    permissions:
      contents: write  # Permission to write to the repository

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}  # GitHub token to interact with repository
        fetch-depth: 0  # Fetch the full history for the repository (needed for checking changes)

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'  # Specify Python version for the environment

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip  # Ensure pip is up to date
        pip install -r requirements.txt  # Install dependencies listed in requirements.txt

    - name: Clean output directory (delete old outputs)
      run: |
        echo "üóëÔ∏è Cleaning output directory..."
        rm -rf output_images/*  # Remove any existing output images
        echo "‚úÖ Old outputs deleted"

    - name: Ensure output directory exists
      run: |
        mkdir -p output_images  # Make sure the output directory exists before saving files
        echo "Output directory ready"

    - name: Process images with 7 effects
      run: |
        echo "üé® Applying effects: Posterize, Anime, Sepia, Dream, CLAHE, Threshold, Mirror"
        python image_processor.py  # This will process the images with the specified effects (including mirror)

    - name: Run tests & display technique summary
      run: |
        echo "=== Running Technique Summary Tests ==="
        python -m pytest -v -s tests/test_image_processing.py  # Run the test script to check if effects are applied correctly

    - name: Display processing results
      run: |
        echo "=== Processed Images ==="
        ls -lh output_images/ || echo "No images processed"  # List the files in the output directory to confirm image generation
        echo ""
        echo "Total files: $(ls output_images/ | wc -l)"  # Count the number of processed images

    - name: Commit and push processed images back to GitHub
      run: |
        git config --global user.name "GitHub Actions Bot"  # Set GitHub Actions Bot as the committer
        git config --global user.email "actions@github.com"  # Set the email for commits
        git add output_images/  # Add processed images to Git staging area
        git diff --staged --quiet || git commit -m "ü§ñ Auto-update: Processed images from workflow"  # Commit changes if there are any new images
        git push origin HEAD:add-two-effects-jr  # Push the changes to the `add-two-effects-jr` branch

    - name: Upload processed images
      uses: actions/upload-artifact@v4
      with:
        name: processed-images  # Name for the artifact
        path: output_images/  # Path to the processed images directory
        if-no-files-found: warn  # If no files are found, issue a warning
